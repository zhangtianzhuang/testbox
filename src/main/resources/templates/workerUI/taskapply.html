<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>成都电务维修段联锁试验模拟装置管理系统</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">

  <!-- Font Awesome Icons 图标风格-->
  <link rel="stylesheet" href="/testbox/static/plugins/fontawesome-free/css/all.min.css">

  <!-- Theme style 主题样式-->
  <link rel="stylesheet" href="/testbox/static/dist/css/adminlte.min.css">

  <!-- 日期表样式 -->
  <link rel="stylesheet" href="/testbox/static/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">

  <!-- Bootstrap Color Picker -->
  <link rel="stylesheet" href="/testbox/static/plugins/bootstrap-colorpicker/css/bootstrap-colorpicker.min.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="/testbox/static/plugins/select2/css/select2.min.css">
  <link rel="stylesheet" href="/testbox/static/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">

</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <!-- Navbar -->
  <!-- 顶端导航栏 -->
  <nav class="main-header navbar navbar-expand navbar-dark navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <!-- 压缩 -->
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
    </ul>

    <!-- 顶端右侧链接 私信、通知、选择 -->
    <ul class="navbar-nav ml-auto">
      <!-- Messages Dropdown Menu -->
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="far fa-comments"></i>
          <span class="badge badge-danger navbar-badge">3</span>  <!-- 消息个数 -->
        </a>
        <!-- 下拉菜单消息 -->
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <a href="#" class="dropdown-item">
            <!-- Message Start -->
            <div class="media">
              <img src="/testbox/static/dist/img/user1-128x128.jpg" alt="User Avatar" class="img-size-50 mr-3 img-circle">
              <div class="media-body">
                <h3 class="dropdown-item-title">
                  Brad Diesel
                  <span class="float-right text-sm text-danger"><i class="fas fa-star"></i></span>
                </h3>
                <p class="text-sm">Call me whenever you can...</p>
                <p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
              </div>
            </div>
            <!-- Message End -->
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <!-- Message Start -->
            <div class="media">
              <img src="/testbox/static/dist/img/user8-128x128.jpg" alt="User Avatar" class="img-size-50 img-circle mr-3">
              <div class="media-body">
                <h3 class="dropdown-item-title">
                  John Pierce
                  <span class="float-right text-sm text-muted"><i class="fas fa-star"></i></span>
                </h3>
                <p class="text-sm">I got your message bro</p>
                <p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
              </div>
            </div>
            <!-- Message End -->
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <!-- Message Start -->
            <div class="media">
              <img src="/testbox/static/dist/img/user3-128x128.jpg" alt="User Avatar" class="img-size-50 img-circle mr-3">
              <div class="media-body">
                <h3 class="dropdown-item-title">
                  Nora Silvester
                  <span class="float-right text-sm text-warning"><i class="fas fa-star"></i></span>
                </h3>
                <p class="text-sm">The subject goes here</p>
                <p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
              </div>
            </div>
            <!-- Message End -->
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item dropdown-footer">See All Messages</a>
        </div>
      </li>
      <!-- Notifications Dropdown Menu -->
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="far fa-bell"></i>
          <span class="badge badge-warning navbar-badge">15</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <span class="dropdown-header">15 Notifications</span>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-envelope mr-2"></i> 4 new messages
            <span class="float-right text-muted text-sm">3 mins</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-users mr-2"></i> 8 friend requests
            <span class="float-right text-muted text-sm">12 hours</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-file mr-2"></i> 3 new reports
            <span class="float-right text-muted text-sm">2 days</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item dropdown-footer">See All Notifications</a>
        </div>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
          <i class="fas fa-user-circle"></i>
        </a>
      </li>
    </ul>
  </nav>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <!-- 左侧标签栏 -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <a href="#" class="brand-link">
      <img src="/testbox/static/dist/img/ChengduLogo.png" alt="Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
      <span class="brand-text font-weight-light">模拟装置管理系统</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar user panel (optional) -->
      <!-- 用户图标和信息 -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          <img src="/testbox/static/dist/img/user2-160x160.jpg" class="img-circle elevation-2" alt="User Image">
        </div>
        <div class="info">
          <a href="#" class="d-block" id="user_nameshow"> 张三 </a>
        </div>
      </div>


      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
          <!-- 树形结构目录 -->
          <!-- 任务管理 -->
          <li class="nav-item has-treeview menu-open">
            <a href="#" class="nav-link active">
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p>
                任务管理
                <i class="right fas fa-angle-left"></i>
              </p>
            </a>
            <ul class="nav nav-treeview">
              <li class="nav-item">
                <a href="/testbox/workers/taskapply" class="nav-link active">
                  <i class="far fa-circle nav-icon"></i>
                  <p>提交任务申请</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/testbox/workers/taskshow" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>查看申请结果</p>
                </a>
              </li>
            </ul>
          </li>
          <!--/.任务管理-->

          <!-- 非树形结构目录 -->
          <li class="nav-item">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-th"></i>
              <p>
                Simple Link
                <span class="right badge badge-danger">New</span>
              </p>
            </a>
          </li>

        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <!-- 主体内容 -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <!-- 内容顶部 -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0 text-dark">提交任务申请表</h1>
          </div><!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">成都</a></li>
              <li class="breadcrumb-item active">任务管理</li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- 页面内容 -->
    <!-- Main content -->
    <div class="content">
      <div class="container-fluid">
        <div class="card card-default" id="apply">
          <div class="card-header">
            <h3 class="card-title">填写任务申请表</h3>
          </div>
          <!-- /.card-header -->
          <div class="card-body">
            <div class="row">
              <!-- 第一列内容 -->
              <div class="col-md-3">
                <div class="form-group">
                  <label>工程名称</label>
                  <input type="text" class="form-control" id="projectName" placeholder="请输入工程名称">
                </div>
                <div class="form-group">
                  <label> 工区名称 </label>
                  <input type="text" class="form-control" id="workArea" placeholder="请输入工区名称">
                </div>
                <div class="form-group">
                  <label>使用地点</label>
                  <input type="text" class="form-control" id="targetRegion" placeholder="请输入工作地点">
                </div>
                <div class="form-group">
                  <label>任务描述</label>
                  <textarea class="form-control" id="taskDesc" rows="3" placeholder="一些描述信息..."></textarea>
                </div>
              </div>
              <!-- /.col -->
              <!-- 第二列内容 -->
              <div class="col-md-3">

                <div class="form-group">
                  <label>领取日期</label>
                  <!-- 日历暂时调不出来 -->
<!--                  <div class="input-group date" id="reservationdate" data-target-input="nearest">-->
                  <div class="input-group date" id="getDate" data-target-input="nearest">
                    <input type="text" id="borrowDate" class="form-control datetimepicker-input" data-target="#getDate"/>
                    <div class="input-group-append" data-target="#getDate" data-toggle="datetimepicker">
                      <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label>归还日期</label>
                  <!-- 日历暂时调不出来 -->
                  <div class="input-group date" id="reservationdate" data-target-input="nearest">
                    <input type="text" id="returnDate" class="form-control datetimepicker-input" data-target="#reservationdate"/>
                    <div class="input-group-append" data-target="#reservationdate" data-toggle="datetimepicker">
                      <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label>申请人</label>
                  <input type="text" class="form-control" id="approverName" placeholder="请输入申请人姓名">
                </div>

              </div>
              <!-- /.col -->

              <!-- 设备列表添加 -->
              <div class="col-md-6">
                <div class="form-group">
                  <label>试验箱</label>
                  <div class="select2-blue">
                    <select class="select2" id="boxList" multiple="multiple" data-placeholder="选择试验箱编号" style="width: 100%">
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <!-- /.row -->
            <!-- 提交按钮 -->
            <div class="row">
              <div class="col-md-4 text-center">
                <!-- 空着 -->
              </div>

              <div class="col-md-1 text-center">
                <button type="submit" class="btn btn-block btn-primary" id="submitapp">提交</button>
              </div>

              <div class="col-md-2 text-center">
              </div>

              <div class="col-md-1 text-center">
                <button type="reset" class="btn btn-secondary btn-block" id="resetapp" onclick="resetAll()">重置</button>
              </div>

              <div class="col-md-4 text-center">
                <!-- 空着 -->
              </div>

            </div>
          </div>
        </div>

        <div class="card card-default" id="applysuccess" style="display: none"> <!-- 默认隐藏 -->
          <div class="card-header">
            <h3 class="card-title">任务申请成功</h3>
          </div>
          <!-- 显示申请表单结果 -->
          <!-- /.card-header -->
          <div class="card-body">
            <dl class="row">
              <dt class="col-sm-4">任务编号</dt>
              <dd class="col-sm-8" id="info_taskID">20200517AZTBDSA</dd>
              <dt class="col-sm-4">申请人</dt>
              <dd class="col-sm-8" id="info_approverName">张三</dd>
              <dt class="col-sm-4">所属工区</dt>
              <dd class="col-sm-8" id="info_projectArea">成都</dd>
              <dt class="col-sm-4">工程名称</dt>
              <dd class="col-sm-8" id="info_projectName">列控检修</dd>
              <dt class="col-sm-4">工作地点</dt>
              <dd class="col-sm-8" id="info_projectPoint">成都普速场</dd>
              <dt class="col-sm-4">申请试验箱编号</dt>
              <dd class="col-sm-8" id="info_boxlist">DZ-1、DJ-1、DJ-2、GW-1</dd>
              <dt class="col-sm-4">使用时间</dt>
              <dd class="col-sm-8" id="info_dateRange">2020/05/06 01:00 — 2020/05/06 04:00</dd>
              <dt class="col-sm-4">任务备注</dt>
              <dd class="col-sm-8" id="info_remark">我是任务备注</dd>
              <dt class="col-sm-4">申请时间</dt>
              <dd class="col-sm-8" id="info_approveDate">2020/05/04 16:09</dd>
            </dl>
            <!-- 确认按钮 返回申请页-->
            <div class="row">
              <div class="col-md-10"></div>
              <div class="col-md-1">
                <button type="reset" class="btn btn-primary btn-block" id="confirm"> 确认 </button>
              </div>
            </div>
          </div>
          <!-- /.card-body -->
        </div>
        <!-- /.container-fluid -->
      </div>

    <!-- /.content -->
    </div>
  <!-- /.content-wrapper -->
  </div>
  <!-- Control Sidebar -->

  <!-- 右侧呼出栏，可以设计成用户登录登出-->
  <aside class="control-sidebar">
    <!-- Profile Image -->
    <div class="card card-primary card-outline">
      <div class="card-body box-profile">
        <div class="text-center">
          <img class="profile-user-img img-fluid img-circle"
               src="/testbox/static/dist/img/user1-128x128.jpg"
               alt="User profile picture">
        </div>

        <h3 class="profile-username text-center " id="user_name">张三</h3>

        <p class="text-muted text-center" id="user_id">20209527</p>

        <ul class="list-group list-group-unbordered mb-3">
          <li class="list-group-item">
            <b>班组</b> <a class="float-right" id="user_groupName">尖刀班</a>
          </li>
          <li class="list-group-item">
            <b>工区</b> <a class="float-right" id="user_projectArea">成都铁路局</a>
          </li>
          <li class="list-group-item">
            <b>电话</b> <a class="float-right" id="user_phone">15600928615</a>
          </li>
        </ul>

        <a href="#" class="btn btn-primary btn-block"><b>退出登录</b></a>
      </div>
      <!-- /.card-body -->
    </div>
    <!-- /.card -->
  </aside>
  <!-- /.control-sidebar -->

  <!-- Main Footer -->
  <footer class="main-footer">
    <!-- To the right -->
    <div class="float-right d-none d-sm-inline">
      成都电务维修段联锁试验模拟装置管理系统
    </div>
    <!-- Default to the left -->
    <!-- 不知道要改成什么 -->
    <strong>Copyright &copy; 2014-2020 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved.
  </footer>
</div>
<!-- ./wrapper -->

<!-- REQUIRED SCRIPTS -->
<!-- jQuery -->
<script src="/testbox/static/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/testbox/static/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<!-- 一些动态响应 -->
<script src="/testbox/static/dist/js/adminlte.min.js"></script>

<!-- moment -->
<!-- 日期转换 -->
<script src="/testbox/static/plugins/moment/moment.min.js"></script>
<script src="/testbox/static/plugins/moment/moment-with-locales.min.js"></script>

<!-- Tempusdominus Bootstrap 4 -->
<script src="/testbox/static/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>

<!-- Select2 -->
<script src="/testbox/static/plugins/select2/js/select2.full.min.js"></script>

<!-- bootstrap color picker -->
<script src="/testbox/static/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js"></script>

<script>
  $('#getDate').datetimepicker({
    fontAwesome:'font-awesome',       // 指定
    locale: moment.locale("zh-cn"),   // 中文
    format: 'YYYY-MM-DD HH:mm:00 A',  // 日期格式化
    autoclose: true,                  // Boolean. 默认值：false。当选择一个日期之后是否立即关闭此日期时间选择器。
  });

  $('#reservationdate').datetimepicker({
    fontAwesome:'font-awesome',        //指定
    locale: moment.locale("zh-cn"),
    format: 'YYYY-MM-DD HH:mm:00 A',  //日期格式化
    autoclose: true,                  //Boolean. 默认值：false。当选择一个日期之后是否立即关闭此日期时间选择器。
  });

  $(document).ready(function(){
    // 初始化多选框主题
    $('#boxList').select2({
      // 绑定服务器的json数据为所有可用的试验箱
      ajax: {
        url: "/testbox/workers/boxes",
        type:'GET',
        dataType: 'json',
      }
    });

    // 获得登录用户信息
    $.ajax({
      url: "/testbox/workers/personInfo",
      type:'GET',
      dataType:'json',
      contentType:'application/json;charset=UTF-8',
      success:function(result){
        console.log(result);
        var userInfo = result.data;
        // 渲染到界面上
        $("#user_nameshow").text(userInfo.workerName);
        $("#user_name").text(userInfo.workerName);
        $("#user_id").text(userInfo.workerNumber);
        $("#user_phone").text(userInfo.workerPhone);
        $("#user_projectArea").text(userInfo.workerArea);
        $("#user_groupName").text(userInfo.workerGroup);
      }
    })
  });

  // 提交申请，隐藏申请界面，显示申请表单
  $("#submitapp").click(function(){

    // 将日期转成moment后再转换成时间戳保存
    var borrowDate = $('#borrowDate').val().split(" ");
    var returnDate = $('#returnDate').val().split(" ");

    // // moment 转日期格式
    // var mom = moment();
    // var current = mom.format("YYYY-MM-DD HH:mm:ss");
    // console.log(current);
    //
    // // moment 转时间戳
    // var currentTimeStamp = mom.valueOf();
    // console.log(currentTimeStamp);
    //
    // // 时间戳转日期格式
    // var date = moment(currentTimeStamp).format("YYYY-MM-DD HH:mm:ss");
    // console.log(date);

    // 将试验箱列表select2转成json列表
    var boxesID = $('#boxList').val();

    var boxesList = new Array();
    for (var i = 0; i < boxesID.length; i++) {
      boxesList.push({
        "boxNumber": $("#boxList").select2("data")[i].text,
        "boxId": boxesID[i]
      });
    }

    var applyForm = {
      "taskName": $('#projectName').val(),
      "workerName": $("#user_name").text(),
      "taskArea": $('#workArea').val(),
      "taskPoint": $('#targetRegion').val(),
      "borrowDate": moment(borrowDate[0]+" "+borrowDate[1]).valueOf(),  // 将bootstrap的时间表格式转换成时间戳
                                                                        // 2020/08/01 23:17:00 晚上
                                                                        // 去掉后缀的一个字符
      "returnDate": moment(returnDate[0]+" "+returnDate[1]).valueOf(),
      "taskDesc": $('#taskDesc').val(),
      "boxes": boxesList,
      // "taskDate": moment().valueOf()     //当前时间的时间戳
    };

    // 将数据表发送给服务器的对应端口
    $.ajax({
      url: "/testbox/workers/task",
      type:'POST',
      dataType:'json',
      contentType:'application/json;charset=UTF-8',
      data:JSON.stringify(applyForm),   // 转换成json格式,其实是不是可以不要
      success:function(data){
        console.log("接收服务器的数据:");
        console.log(data);
        // 解析返回的数据，修改显示申请的表单内容
        var task = data.data;
        console.log(task)
        var borrowDate = moment(task.borrowDate).format("YYYY-MM-DD HH:mm:ss");
        var returnDate = moment(task.returnDate).format("YYYY-MM-DD HH:mm:ss");
        var boxList = "";
        for(var i = 0; i < task.boxes.length; i++){
          boxList += task.boxes[i].boxNumber;
          boxList += " ";
        }

        $("#info_taskID").text(task.taskNumber);
        $("#info_approverName").text(task.taskWorkerName);
        $("#info_projectArea").text(task.Area);
        $("#info_projectName").text(task.taskName);
        $("#info_projectPoint").text(task.taskPoint);
        $("#info_boxlist").text(boxList);
        $("#info_dateRange").text(borrowDate + "~" + returnDate);
        $("#info_remark").text(task.taskDesc);
        $("#info_approveDate").text(moment(task.taskDate).format("YYYY-MM-DD HH:mm:ss"));
      }
    });

    // 显示表单申请结果，隐藏表单界面
    $("#apply").toggle();
    $("#applysuccess").css("display","block");
  });

  // 确认申请，隐藏表单信息，回到清空后的申请界面
  $("#confirm").click(function () {
    window.location.reload()  // 刷新当前页面.
  });



</script>
</body>
</html>
